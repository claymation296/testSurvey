<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->


<link rel="import" href="../redaap-behaviors/utilities.html">
<link rel="import" href="../redaap-behaviors/tab-page-animation-behavior.html">
<link rel="import" href="../redaap-behaviors/on-tap-behavior.html">


<dom-module id="account-form">
  <template>
  	<style include="shared-styles"></style>
    <style>

      :host {
        display: flex;
        justify-content: center;
      }

      #content {
        width: 100%;
        max-width: 460px;
      }

      gold-phone-input {
        width: 100%;
      }

      gold-zip-input {
        width: 100%;
      }

      .bottomPadding {
        padding-bottom: 16px;
      }

    </style>


    <div id="content">


      <div id="clientCards" class="clientCards">
        <paper-card heading="Client Information" class="title">
        	<div class="card-content">
        		<paper-input label="Primary Contact Name *"
                         autocapitalize 
                         autocomplete 
                         autocorrect 
                         required 
                         maxLength="30" 
                         char-counter
                         allowed-pattern="[a-zA-Z\s]"
                         prevent-invalid-input 
                         value="{{inputs.clientName}}">
            </paper-input>
            <gold-phone-input id="phone"
                              label="Phone Number *"
                              auto-validate 
                              required
                              maxLength="12"
                              value="{{inputs.phone}}">
            </gold-phone-input>
            <!-- dont allow spaces, newline, carriage returns, etc. 
                 allow any alphanumeric combo before one '@' followed by 
                 any alphanumeric combo followed by one '.' followed by any alphanumeric combo -->
            <paper-input id="email"
                         label="Email *"
                         type="email"
                         allowed-pattern="[^\s\f\n\r\t\v]"
                         prevent-invalid-input 
                         pattern=".+@{1}.+\.{1}.+"
                         auto-validate 
                         required 
                         error-message="Please enter a valid email format"
                         value="{{inputs.email}}">
            </paper-input>
            <paper-input label="Company *"
                         autocapitalize 
                         autocomplete 
                         autocorrect
                         required 
                         maxLength="30" 
                         char-counter
                         allowed-pattern="[0-9a-zA-Z\s]"
                         prevent-invalid-input 
                         value="{{inputs.companyName}}">
            </paper-input>
            <paper-input label="Address"
                         autocapitalize 
                         autocomplete 
                         autocorrect
                         maxLength="30" 
                         char-counter
                         allowed-pattern="[.#0-9a-zA-Z\s]"
                         prevent-invalid-input 
                         value="{{inputs.address}}">
            </paper-input>
            <paper-input label="City"
                         autocapitalize 
                         autocomplete 
                         autocorrect 
                         auto-validate
                         maxLength="30" 
                         char-counter 
                         allowed-pattern="[a-zA-Z\s]"
                         prevent-invalid-input
                         value="{{inputs.city}}">
            </paper-input>
            <paper-input id="state"
                         label="State Abbreviation"
                         auto-validate
                         char-counter
                         autocapitalize
                         allowed-pattern="[a-zA-Z]"
                         prevent-invalid-input
                         minLength="2" 
                         maxLength="2"
                         error-message="Please use two letter state code only"
                         value="{{inputs.state}}">
            </paper-input>
            <gold-zip-input id="zip"
                            auto-validate
                            value="{{inputs.zip}}">
            </gold-zip-input>
          </div>
          <paper-item class="noSelect">* required fields</paper-item>
        </paper-card>

        <paper-card heading="Project Information" class="title bottomPadding">
          <div class="card-content">
            <paper-button class="buttons" 
                          on-tap="_sameAsClientButtonTapped" 
                          raised>same as client
            </paper-button>
            <paper-input label="Project Name"
                         autocapitalize autocomplete autocorrect
                         maxLength="30" char-counter
                         allowed-pattern="[#0-9a-zA-Z\s]"
                         prevent-invalid-input 
                         value="{{inputs.projectName}}">
            </paper-input>
            <paper-input label="Project Address"
                         autocapitalize 
                         autocomplete 
                         autocorrect
                         maxLength="30" 
                         char-counter
                         allowed-pattern="[.#0-9a-zA-Z\s]"
                         prevent-invalid-input
                         value="{{inputs.projectAddress}}">
            </paper-input>
            <paper-input label="Project City"
                         autocapitalize 
                         autocomplete 
                         autocorrect
                         auto-validate
                         maxLength="30" 
                         char-counter 
                         allowed-pattern="[a-zA-Z\s]"
                         prevent-invalid-input
                         value="{{inputs.projectCity}}">
            </paper-input>
            <paper-input id="projectState"
                         label="Project State Abbreviation"
                         auto-validate
                         char-counter
                         autocapitalize
                         allowed-pattern="[a-zA-Z]"
                         prevent-invalid-input
                         minLength="2" 
                         maxLength="2"
                         error-message="Please use two letter state code only"
                         value="{{inputs.projectState}}">
            </paper-input>
            <gold-zip-input id="projectZip"
                            auto-validate
                            value="{{inputs.projectZip}}">
            </gold-zip-input>
            <paper-input label="Project Site Contact"
                         autocapitalize 
                         autocomplete 
                         autocorrect  
                         maxLength="30" 
                         char-counter
                         allowed-pattern="[a-zA-Z\s]"
                         prevent-invalid-input
                         value="{{inputs.projectContact}}">
            </paper-input>
            <paper-input label="Project Job Description"
                         autocapitalize 
                         autocomplete 
                         autocorrect
                         maxLength="30" 
                         char-counter
                         value="{{inputs.projectDescription}}">
            </paper-input>
          </div>    
        </paper-card>
      </div>

      <div class="bottomPadding96"></div>
    </div>
	  	
  </template>

  <script>
    (function() {
      Polymer({
        is: 'account-form',

        behaviors: [
          window.Redaap.Behaviors.Utilities,                
          window.Redaap.Behaviors.TabPageAnimationBehavior, 
          window.Redaap.Behaviors.OnTapBehavior             
        ],

        properties: {
          // shares data with main-page and localstorage
          client: {
          	type: Object,
          	notify: true,
            observer: '_clientChanged'
          },


          inputs: {
            type: Object,
            value: {
              clientName: '',
              phone: null,
              email: '',
              companyName: '',
              address: '',
              city: '',
              state: '',
              zip: '',
              projectName: '',
              projectAddress: '',
              projectCity: '',
              projectState: '',
              projectZip: '',
              projectContact: '',
              projectDescription: '',
              surveyVersion: null
            }
          },
          // used to clear inputs
          clearInputs: {
            type: Object,
            value: {
              clientName: '',
              phone: null,
              email: '',
              companyName: '',
              address: '',
              city: '',
              state: '',
              zip: '',
              projectName: '',
              projectAddress: '',
              projectCity: '',
              projectState: '',
              projectZip: '',
              projectContact: '',
              projectDescription: '',
              surveyVersion: null
            }
          },
          // displayed in app main toolbar middle
          displayedClientCompanyName: {
            type: String,
            notify: true,
            computed: '_computeDisplayedClientCompanyName(inputs.companyName)'
          },
          // a list of element id's that will be checked for proper format validity
          idArray: {
            type: Array,
            value: [
              '#phone',
              '#email',
              '#state',
              '#zip',
              '#projectState',
              '#projectZip'
            ]
          },
          // survey version if not original copy
          version: {
          	type: Number,
          	observer: '_newVersion'
          },
          // state of all inputs
          // paper-fab tap calls _load function which checks input validity
          clientValid: {
          	type: Boolean,
          	value: false,
          	notify: true,
            observer: '_clientValidChanged'
          },
          // allow user to easily nav to signage or lighting menu once client info is complete
          route: {
            type: String,
            notify: true
          },
          // skip initial definition of inputs
          initialLoad: {
            type: Boolean,
            value: true
          }
        },


        observers: [
        	'_inputsChanged(inputs.*)'
        ],


        // !!!!!!!!!!@@@@@@####### temporary solution until a 'home' page is created $$$$$$$$%%%%
        attached() {
          if (this.route === 'home') {
            this.set('route', 'client');
          }          
        },


        _computeDisplayedClientCompanyName: str => (str.length > 25) ? `${str.slice(0, 22)}...` : str,


        _updateInputsFromLocalstorage(client) {
          // must iterate through this.inputs in order to propagate data down
          // to local dom inputs (Object.assign will not work here 3/10/2017)
          const keys = Object.keys(client);

          keys.forEach(key => {
            const val = client[key];
            if (val) {
              this.set(`inputs.${key}`, val);
            }
          });
        },


        _clientChanged(client, oldClient) {
          this.set('clientValid', false);
          // oldClient undefined on initial page load 
          // and client becomes truthy when app-state sets it
          if (client && !oldClient) {
            this._updateInputsFromLocalstorage(client);
          }
        },


        _inputsChanged(inputs) {
          this.debounce('account-inputs-debounce', () => {
            // the first time inputs is changed is when it is initially defined
            // which blows away this.client if there is data saved in app-state
            // so skip the initial inputs definition
            if (this.initialLoad) {
              this.initialLoad = false;
              return;
            }

            this.client = null;
            this.set('client', inputs.base);
          }, 100);
        },

        
        _clientValidChanged(bool, oldBool) {
          if (oldBool === undefined) { return; }

          window.Redaap.accountBadge.hidden = !bool;
          // scroll to top of account-form to display nav buttons
          if (this.route === 'client' && bool) {
            const scrollUp = () => {
              window.Redaap.mainScroll.scrollToTop(true);
            };

            this.schedule(scrollUp);
          }
        },

        _searchObject(obj, value) {
          const requiredFields = key => {
            const required = (
              key === 'clientName' ||
              key === 'phone'      ||
              key === 'email'      ||
              key === 'companyName'
            );

            return required;
          };

          for (const key in obj) {
            if (requiredFields(key)) {
              if (!obj[key] || obj[key].trim() === value) {
                return true;
              }
            }
          }

          return false;
        },

        // called by account-fab
        checkForm() {
          const load = () => {
            // create a function that returns a boolean based on the client obj values
            // true if any inputs are left blank and false if they have all been filled in
            const emptyInput = this._searchObject(this.client, '');
            // loop through this.idArray to find any elements with false values
            // meaning an input field value has an invalid format
            // if the element has a value, run the validate method, otherwise return true
            const validInput = this.idArray.every(el => this.$$(el).value ? this.$$(el).validate() : true);
            // check form for a signature and all completed fields
            if (emptyInput) {
              this.set('clientValid', false);
              this.warn('Please complete all required fields');
            } else if (!validInput) {
              this.set('clientValid', false);
              this.warn('Please check the format of all required fields');
            } else {
              this.set('clientValid', true);
              // listened for in lighting-main
              this.fire('account-form-validated');
            }
          };

          this.schedule(load);
        },

        // called from paper-button
        _sameAsClientButtonTapped() {
          const setInputs = () => {
            // allow user to copy entries to matching project inputs if
            // they are the same place 
            const {companyName, address, city, state, zip} = this.inputs;

            this.set('inputs.projectName',    companyName);
            this.set('inputs.projectAddress', address);
            this.set('inputs.projectCity',    city);
            this.set('inputs.projectState',   state);
            this.set('inputs.projectZip',     zip);
          };
          // onTap property found in redaap-behaviors/on-tap-behavior
          this.onTap = setInputs;
        },

        // called by survey-search.html anytime the user loads in an old survey
        reloadClientFromSavedSurvey(obj) {
          const reload = () => {
            this.inputs = undefined;
            this.set('inputs', obj);
          };
          
          this.schedule(reload);
        },
        // clearClient is called by lighting-main
        // when user chooses to clear the survey
        clearClient() {
          const clear = () => {
            this.inputs = undefined;
            this.set('inputs', Object.assign({}, this.clearInputs));
          };
          
          this.schedule(clear);
        },

        // passed in from main-page
        _newVersion(v) {
        	this.set('inputs.surveyVersion', v);
        }

      });
    })();
  </script>

</dom-module>
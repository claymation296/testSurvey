<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->


<link rel="import" href="../redaap-behaviors/utilities.html">
<link rel="import" href="../redaap-behaviors/on-tap-behavior.html">


<dom-module id="lighting-tabs">
  <template>
    <style include="shared-styles"></style>
    <style>

      :host {
      	display: flex;
        justify-content: center;
        position: absolute;
        left: 0px;
		    transition: opacity 0.2s ease-in-out;
      }

    </style>

      <template is="dom-if" if="[[showQuoteTabs]]">
        <paper-tabs selected="{{lightingTab}}" attr-for-selected="tabname" selected-class="selectedTab">
          <span class="flex"></span>
          <paper-tab tabname="areaPage">
            <iron-icon id="quoteAreaTabIcon" icon="custom-icons:room"></iron-icon>
            <span class="tabLabel">Areas</span>
          </paper-tab>
          <span class="flex"></span>
          <paper-tab tabname="quoteSelector">
            <iron-icon id="quotePricingTabIcon" icon="custom-icons:assignment"></iron-icon>
            <span class="tabLabel">Pricing</span>
          </paper-tab>
          <span class="flex"></span>
        </paper-tabs>

        <paper-badge id="quoteAreaBadge" 
                     class="badge"
                     for="quoteAreaTabIcon" 
                     label="[[quoteBadgeCount]]">
        </paper-badge>
        <paper-badge id="quotePricingBadge" 
                     class="badge"
                     for="quotePricingTabIcon" 
                     icon="custom-icons:check">
        </paper-badge>
      </template>


      <template is="dom-if" if="[[!showQuoteTabs]]">
        <paper-tabs selected="{{lightingTab}}" attr-for-selected="tabname" selected-class="selectedTab">
          <span class="flex"></span>
          <paper-tab tabname="areaPage">
            <iron-icon id="bomAreaTabIcon" icon="custom-icons:room"></iron-icon>
            <span class="tabLabel">Areas</span>
          </paper-tab>
          <span class="flex"></span>
          <paper-tab tabname="bomSend">
            <iron-icon id="bomSendTabIcon" icon="custom-icons:send"></iron-icon>
            <span class="tabLabel">Send</span>
          </paper-tab>
          <span class="flex"></span>
        </paper-tabs>

        <paper-badge id="bomAreaBadge" 
                     class="badge"
                     for="bomAreaTabIcon" 
                     label="[[bomBadgeCount]]">
        </paper-badge>
        <paper-badge id="bomSendBadge" 
                     class="badge"
                     for="bomSendTabIcon" 
                     icon="custom-icons:check">
        </paper-badge>
      </template>


  </template>

  <script>
    (function() {
      Polymer({
        is: 'lighting-tabs',

        behaviors: [ 
          window.Redaap.Behaviors.Utilities,
          window.Redaap.Behaviors.OnTapBehavior 
        ],

        properties: {
        	// bound from lighting-main
        	lightingTab: {
        		type: String,
            value: 'areaPage',
        		notify: true
        	},

          bom: Object,
        	// bound from lighting-main
        	userSelectedArray: Array,
          // passed in from account-form via main-page if all inputs are complete and valid
          clientValid: {
            type: Boolean,
            observer: '_clientValidChanged'
          },

          bomBadgeCount: {
            type: Number,
            computed: '_computeBomBadgeCount(bom.*)'
          },
          // display the number of cards/fixtures in area-tab badge
          quoteBadgeCount: {
            type: Number,
            computed: '_computeQuoteBadgeCount(userSelectedArray.*)'
          },
          // pull in the main menu routing string
          // hide tabs unless on 'home' page
          route: {
            type: String,
            observer: '_routeChanged'
          },
          // lighting modes 'quote'/'bom'
          mode: {
            type: String,
            observer: '_modeChanged'
          }
        },


        listeners: {
          'dom-change': '_ifTemplateDomChanged'
        },


        _ifTemplateDomChanged() {
          this.debounce('lightingTabsDebounce', () => {
            const hide = () => {
              // hide quote badge as default to prevent it from an initial flash
              // if uSA or bom is empty or undefined
              if (this.mode && this.mode === 'bom') {
                this._applyHideClass(true, this.$$('#bomSendBadge'));
                return;
              }
              this._applyHideClass(true, this.$$('#quotePricingBadge'));
            };

            this._show();
            this.schedule(hide);
          }, 10);
        },


        _modeChanged(mode, oldMode) {
          if (mode) {
            if (mode === 'quote') {
              this.showQuoteTabs = true;
            } else {
              this.showQuoteTabs = false;
            }
            // if user clears app and stays in same mode
            if (!oldMode) {
              this._show();
            }
          }
        },


        _applyHideClass(bool, badge) {
          if (!badge) { return; }
          const apply = () => {
            this.toggleClass('hideBadge', bool, badge);
            badge.updatePosition();
            this.updateStyles();
          };
          
          this.schedule(apply);
        },


        _clientValidChanged(bool) {
          if (bool) {
            if (this.quoteBadgeCount) {
              this._applyHideClass(false, this.$$('#quotePricingBadge'));
            } else if (this.bomBadgeCount) {
              this._applyHideClass(false, this.$$('#bomSendBadge'));
            }
          } else {
            if (this.showQuoteTabs) {
              this._applyHideClass(true, this.$$('#quotePricingBadge'));
            } else {
              this._applyHideClass(true, this.$$('#bomSendBadge'));
            }
          }
        },

        // common badge state code
        _hideAreaTabBadges(bool) {
          this.debounce('badgeDebounce', () => {
            if (!this.quoteBadgeCount) {
              this._applyHideClass(true, this.$$('#quoteAreaBadge'));
            } else {
              this._applyHideClass(bool, this.$$('#quoteAreaBadge'));
            }

            if (!this.bomBadgeCount) {
              this._applyHideClass(true, this.$$('#bomAreaBadge'));
            } else {
              this._applyHideClass(bool, this.$$('#bomAreaBadge'));
            }
          }, 100);
        },

        // control transitions of account and quote badges on route changes
        _hideQuotePricingTabBadge(bool) {
          this.debounce('otherBadgesDebounce', () => {
            if (this.quoteBadgeCount) {
              this._applyHideClass(bool, this.$$('#quotePricingBadge'));
            }
          }, 100);
        },
        

        _hide() {
          this.style.opacity = '0';
          this._hideQuotePricingTabBadge(true);
          this._hideAreaTabBadges(true);
          this.async(() => {
            // so user cannot access tabs
            const hideTabs = () => this.style.display = 'none';
            this.schedule(hideTabs);
          }, 200);
        },


        _show() {
          if (!this.mode || this.route !== 'lights') { return; }

          const showTabs = () => {
            this.style.display = 'flex';
            this.async(() => {
              this.style.opacity = '1';
              this._hideQuotePricingTabBadge(false);
              this._hideAreaTabBadges(false);
            }, 1);
          };
          // wait for other tabs to hide
          this.async(() => {
            this.schedule(showTabs);
          }, 250);
        },

        // only show tabs and badge if on 'home' page
        _routeChanged(route) {
          if (route === 'lights') {
            this._show();
          } else {
            this._hide();
          }
        },


        _computeBomBadgeCount(obj) {
          if (!obj) { return; }

          const base = Object.getOwnPropertyDescriptor(obj, 'base');

          if (!base.value) { return; }

          const areas = base.value.areas;
          const array = Object.keys(areas);
          const count = array.length;

          if (!count) {
            this._hideAreaTabBadges(true);
            this._applyHideClass(true, this.$$('#bomSendBadge'));
          } else {
            this._hideAreaTabBadges(false);
            if (this.clientValid) {
              this._applyHideClass(false, this.$$('#bomSendBadge'));
            }
          }

          return count;
        },

        // display the number of saved fixtures in a badge over the 'Saved Fixtures' tab
        _computeQuoteBadgeCount(array) {
          // make sure we are dealing with an array
          if (Array.isArray(array.base)) {
          	// displayed number in area badge
            const length = array.base.length;
            // hide the badge if length is less than 1
            // hide the badge upon first load or reload of the site
            // with a clean survey ie. userSelectedArray === []
            if (length) {
              this._hideAreaTabBadges(false);
              return length;
            } else {
              this._hideAreaTabBadges(true);              
              // set length to null for animation purposes
              // otherwise the text '0' appears for a brief instant before the badge fades out
              return null;
            }
          }
          this._hideAreaTabBadges(true);
          return null;
        }


      });
    })();
  </script>

</dom-module>
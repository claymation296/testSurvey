<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->




<dom-module id="app-state">
  <template>
    <style>

      :host {
      	display: none;
      }      

    </style>


    <iron-localstorage name="redaap-state"
                       value="{{state}}"
                       on-iron-localstorage-load="_stateLocalstorageLoaded"
                       on-iron-localstorage-load-empty="_initializeDefaultState"
                       error-message="{{localStorageError}}">
    </iron-localstorage>


    <iron-localstorage name="redaap-cachedState"
                       value="{{cachedState}}"
                       error-message="{{localStorageError}}">
    </iron-localstorage>


    <iron-localstorage name="redaap-email"
                       value="{{email}}"
                       error-message="{{localStorageError}}">
    </iron-localstorage>


    <iron-localstorage name="redaap-channel"
                       value="{{channel}}"
                       error-message="{{localStorageError}}">
    </iron-localstorage>


    <firebase-app api-key="AIzaSyA7lC69yQkPBFAfl9dOLCFbSxnbReE7PFA"
                  auth-domain="redaapsurvey.firebaseapp.com"
                  database-url="https://redaapsurvey.firebaseio.com/"
                  storage-bucket="redaapsurvey.appspot.com"
                  messaging-sender-id="887370986753">
    </firebase-app>


    <firebase-auth id="auth" 
                   signed-in="{{signedIn}}"
                   on-error="_firebaseAuthError">
    </firebase-auth>


    <firebase-document id="doc" 
                       path="/channels/[[channel]]"
                       data="{{state}}"
                       disabled="[[disableFirebase]]"
                       on-error="_firebaseDocError">
    </firebase-document>


  </template>


  <script>
    (function() {
      Polymer({
        is: 'app-state',

        properties: {

        	state: {
        		type: Object,
        		notify: true
        	},
          // cachedState has a non null value during unlinking process
          // it holds the last state value in localstorage cache
          // so as not to accedentally lose users's data
          cachedState: Object,

          defaultState: {
            type: Object,
            value: {
              bom: {
                areas: {}, 
                fixtures: {}, 
                photos: {}
              },
              client: {
                clientName: '',
                phone: '',
                email: '',
                companyName: '',
                address: '',
                city: '',
                state: '',
                zip: '',
                projectName: '',
                projectAddress: '',
                projectCity: '',
                projectState: '',
                projectZip: '',
                projectContact: '',
                projectDescription: '',
                surveyVersion: null
              },
              clientValid: false,
              dreading: {},
              mode: 'quote',
              userSelectedArray: []
            }
          },
          // cache email for user experience during login
          email: {
            type: String,
            notify: true
          },
          // firebase data channel that can be shared across devices/users
          channel: {
            type: String,
            // observer: '_channelChanged'
          },
          // when not in app-link mode revert back to localstorage
          // for full offline capabilities
          disableFirebase: {
            type: Boolean,
            value: true
          },
          // firebase user
          signedIn: Boolean,
          // only true when user is both in app linked mode and offline
          // during this state, firebase can no longer sync to other users
          // and there is not currently a vialbe method for conflict resolution
          // for offline edits, so put app in read only state 
          // disable all inputs and theme app in grey
          readOnly: {
            type: Boolean,
            value: false,
            notify: true
          }

        },


        ready() {
          window.addEventListener('online',  this._handleLinkedAppConnectivity.bind(this));
          window.addEventListener('offline', this._handleLinkedAppConnectivity.bind(this));
        },


        _handleLinkedAppConnectivity(event) {
          // this.channel truthy when in app linking mode
          if (event.type === 'offline' && this.channel) {
            this.set('readOnly', true);
          } else if (event.type === 'online') {
            this.set('readOnly', false);
            // if user unlinked app while offline
            // cleanup firebase registered users
            if (!this.channel && this.signedIn) {
              this.$.auth.user.delete();
            }
          }
        },


        _objIsEmpty: obj => Object.keys(obj).length === 0,


        _setState(newState) {
          this.set('state', Object.assign({}, newState));
        },


        // _channelChanged(channel) {
        //   if (!channel) { return; }


        //   // console.log('channel changed: ', this.state);

        //   if (window.navigator.onLine) {
        //     this.$.doc.getStoredValue(`/channels/${channel}`).
        //     then(state => {

        //       console.log('firebase state init: ', this.tempState);


        //       // if (this._objIsEmpty(state)) {
        //       //   if (this.cachedState === null) {
        //       //     this.set('state', this.defaultState);

        //       //     console.log('firebase default state: ', this.state);
        //       //   } else {
        //       //     this.set('state', this.cachedState);
        //       //     this.cachedState = null;


        //       //     console.log('firebase cached state: ', this.state);
        //       //   }
        //       // }



        //       if (this.tempState === null || this.tempState === undefined) {
        //         if (this._objIsEmpty(state)) {
        //           this._setState(this.defaultState);

        //           console.log('firebase default state: ', this.state);
        //         }
        //       } else {
        //         this._setState(this.tempState);
        //         this.tempState = null;


        //         console.log('firebase temp state: ', this.state);
        //       }






        //     }).
        //     catch(error => console.log('firebase getStoredValue error: ', error));

        //   } else {
        //     if (this.tempState === null || this.tempState === undefined) {
        //       if (this._objIsEmpty(this.state)) {
        //         this._setState(this.defaultState);

        //         console.log('offline default state: ', this.state);
        //       }
        //     } else {
        //       this._setState(this.tempState);
        //       this.tempState = null;


        //       console.log('offline temp state: ', this.state);
        //     }
        //   }
          
          
        // },

        // called by link-app _send()
        getChannel() {

          // TODO:
          //      switch to this.$.auth.signInWithCustomToken()
          //      and get new channel from web-worker getKey()

          this.cachedState     = this.state;
          this.disableFirebase = false;

          return this.$.auth.signInAnonymously().
            then(user => {
              const {uid: channel} = user;
              this.channel         = channel;

              return this.$.doc.setStoredValue(`/channels/${channel}`, this.cachedState);
            }).
            then(() => this.channel);
        },

        // called by realtime-collaboration _link()
        linkApp(channel) {

          // TODO:
          //      switch to this.$.auth.signInWithCustomToken()
          //      and get new channel from web-worker getKey()


          this.disableFirebase = false;
          // show toast only after firebase fully initializes
          return this.$.auth.signInAnonymously().
            then(() => {
              // switch to inviter's channel
              this.channel = channel;
              return this.$.doc.getStoredValue(`/channels/${channel}`);
            }).
            catch(error => console.log('firebase sign in error: ', error));
        },

        // called by link-app _unlink()
        unlinkApp() {


          // TODO:
          //      switch to using this.$.auth.signOut() and web-worker's getKey()
          //      for new channel after moving to this.$.auth.signInWithCustomToken()


          // TODO: 
          //      destroy the channel when the last person signed into it
          //      signs out or unlinks




          // hold state in localstorage in case of page refresh
//          this.cachedState     = this.state;


          this.disableFirebase = true;
          this.channel         = null;
          this.set('readOnly', false);
          // switch to new channel to guarantee the previously linked
          // user can no longer make changes to this user's data
          return this.$.auth.user.delete().
            catch(error => console.log(error));
        },

        // called by web-worker
        signOut() {



          // TODO:
          //      test to make sure a user signing out does not 
          //      destroy the linked channel data for other users
          //      who may still be linked

          // TODO: 
          //      destroy the channel when the last person signed into it
          //      signs out or unlinks




          if (this.signedIn) {
            this.unlinkApp();
          }
        },


        _firebaseAuthError(error) {
          console.log('firebase auth error: ', error);
        },


        _firebaseDocError(error) {
          console.log('firebase doc error: ', error);
        },


        // observers: [
        // 	'_stateChanged(state.*)'
        // ],


        // _stateChanged(state) {
        // 	console.log('state changed: ', state.base);
        // },



        _initializeDefaultState() {
          this._setState(this.defaultState);
        },



        _stateLocalstorageLoaded() {
          // if (!this._objIsEmpty(this.state)) {
          //   this.tempState = this.state;
          //   console.log('state localstorage not empty: ', this.tempState);
          // }
        },


        // _initializeDefaultState() {
        // 	this.set('state', {});
        // },
        

        _localStorageError(error) {
          console.log('app-state localstorage error: ', error);
        }

        // example bom object
        // bom: {
          //   type: Object,
          //   value: {
          //     areas: {
          //       'office': {
          //         fixtures: {
          //           '8in_can': true,
          //           '2x4_troffer': true
          //         },
          //         photos: {
          //           '144443843_433': true
          //         }
          //       },
          //       'break_room': {
          //         fixtures: {
          //           '2x4_troffer': true
          //         },
          //         photos: {
          //           '14476453_349': true
          //         }
          //       },
          //       'main_entrance': {
          //         fixtures: {
          //           '8in_can': true
          //         },
          //         photos: {
          //           '14473455_146': true
          //         }
          //       }
          //     },
          //     fixtures: {
          //       '8in_can': {
          //         'office': {
          //           base: 'e26',
          //           catagory: 'can',
          //           color: 'white',
          //           contactors: '',
          //           controls: {
          //             'dimmer': true,
          //             'light': false,
          //             'motion': false,
          //             'timer': false
          //           },
          //           days: '5',
          //           emergency: '',
          //           height: '8',
          //           hours: '12',
          //           icon: 'canLight',
          //           kelvin: '4500',
          //           label: '8 inch Can',
          //           lamps: 1,
          //           mount: '',
          //           notes: '',
          //           photos: {
          //             '144443843_433': true
          //           },
          //           qty: 7,
          //           type: '8in',
          //           volts: '120',
          //           watts: '20'
          //         },
          //         'main_entrance': {
          //           base: 'pl',
          //           catagory: 'can',
          //           color: 'white',
          //           contactors: '',
          //           controls: {
          //             'dimmer': false,
          //             'light': false,
          //             'motion': false,
          //             'timer': true
          //           },
          //           days: '7',
          //           emergency: '',
          //           height: '12',
          //           hours: '8',
          //           icon: 'canLight',
          //           label: '8 inch Can',
          //           kelvin: '5000',
          //           lamps: 2,
          //           mount: '',
          //           notes: '',
          //           photos: {
          //             '144475694_394': true
          //           },
          //           qty: 4,
          //           type: '8in',
          //           volts: '120',
          //           watts: '32'
          //         }
          //       },
          //       '2x4_troffer': {
          //         'break_room': {
          //           base: 'tombstone',
          //           catagory: 'troffer',
          //           color: 'white',
          //           contactors: '',
          //           controls: {
          //             'dimmer': false,
          //             'light': false,
          //             'motion': true,
          //             'timer': false
          //           },
          //           days: '7',
          //           emergency: '',
          //           height: '10',
          //           hours: '14',
          //           icon: 'fluorescent',
          //           kelvin: '4500',
          //           label: '2x4 Troffer',
          //           lamps: 3,
          //           mount: '',
          //           notes: '',
          //           photos: {
          //             '14476453_349': true
          //           },
          //           qty: 4,
          //           type: '2x4',
          //           volts: '208',
          //           watts: '24'
          //         },
          //         'office': {
          //           base: 'tombstone',
          //           catagory: 'troffer',
          //           color: 'white',
          //           contactors: '',
          //           controls: {
          //             'dimmer': false,
          //             'light': true,
          //             'motion': false,
          //             'timer': true
          //           },
          //           days: '7',
          //           emergency: '',
          //           height: '10',
          //           hours: '12',
          //           icon: 'fluorescent',
          //           kelvin: '4500',
          //           label: '2x4 Troffer',
          //           lamps: 2,
          //           mount: '',
          //           notes: '',
          //           photos: {
          //             '14473455_146': true
          //           },
          //           qty: 6,
          //           type: '2x4',
          //           volts: '208',
          //           watts: '28'
          //         }
          //       }
          //     },
          //     photos: {
          //       '144443843_433': {
          //         area: 'office',
          //         fixture: '8in_can',
          //         orientation: 0,
          //         placeholder: '',
          //         savedUrl: ''
          //       },
          //       '144475694_394': {
          //         area: 'main_entrance',
          //         fixture: '8in_can',
          //         orientation: 6,
          //         placeholder: '',
          //         savedUrl: ''
          //       },
          //       '14476453_349': {
          //         area: 'break_room',
          //         fixture: '2x4_troffer',
          //         orientation: 0,
          //         placeholder: '',
          //         savedUrl: ''
          //       },
          //       '14473455_146': {
          //         area: 'office',
          //         fixture: '2x4_troffer',
          //         orientation: 0,
          //         placeholder: '',
          //         savedUrl: ''
          //       }
          //     }              
          //   }
          // }


      });
    })();
  </script>

</dom-module>

<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->



<link rel="import" href="../redaap-behaviors/utilities.html">
<link rel="import" href="../redaap-behaviors/on-tap-behavior.html">
<link rel="import" href="../redaap-behaviors/open-close-fullscreen-behavior.html">
<link rel="import" href="../redaap-behaviors/expand-collapse-classes-behavior.html">
<link rel="import" href="../close-save-button/close-save-button.html">
<link rel="import" href="../photo-capture/photo-capture.html">
<link rel="import" href="../notes-page/notes-button.html">



<dom-module id="bom-edit-fullscreen">
  <template>
    <style include="shared-styles"></style>
    <style>

      :host {
      	@apply(--fullscreen-elements);
        background-color: var(--primary-background-color);
      }

      paper-scroll-header-panel {
        --paper-scroll-header-panel-full-header: {
          background-color: transparent;
        };
        --paper-scroll-header-panel-condensed-header: {
          background-color: var(--light-primary-color);
        };
        --paper-scroll-header-panel-header-container: {
          background-color: var(--light-primary-color);
        };
        --paper-scroll-header-panel-container: {
          display: flex;
          justify-content: center;
          background-color: var(--primary-background-color);
        };
      }

      paper-toolbar {
        color: var(--primary-text-color);
        --paper-toolbar-background: transparent;
      }

      .itemIcons {
        --iron-icon-width: 48px;
        --iron-icon-height: 48px;
        --iron-icon-stroke-color: var(--primary-text-color);
      }

      photo-capture {
        --photo-capture-background-color: transparent;
      }

      .total {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 56px;
        height: 56px;
        position: absolute;
        bottom: -28px;
        right: 16px;
        color: var(--text-primary-color);
        background-color: var(--default-primary-color);
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      #content {
        width: 220px;
        margin: 32px 0px;
      }

      paper-dropdown-menu {
        display: block;
      }

      .controlsLabel {
        margin-top: 32px;
      }

      paper-checkbox {
        display: block;
        margin: 16px 0px;
      }

      #lastInput {
        margin-bottom: 64px;
      }
      
    </style>

    <paper-scroll-header-panel id="panel">
      <paper-toolbar id="toolbar" class="tall">
        <paper-icon-button id="backButton" 
                           on-tap="_bomBackButtonTapped" 
                           icon="custom-icons:arrow-back">
        </paper-icon-button>
        <span id="title" class="flex title">[[area]]</span>

        <photo-capture id="capture" 
                       filename="[[light.label]]"
                       key="{{photo.key}}"
                       keys="{{photo.keys}}"
                       orientation="{{photo.orientation}}"
                       placeholder="{{photo.placeholder}}"
                       saved-url="{{photo.savedUrl}}" 
                       disable-thumbnail
                       defer-load 
                       defer-trigger="{{deferPhoto}}">
        </photo-capture>

        <notes-button id="notes" existing-fixture="{{light}}"></notes-button>

        <close-save-button id="closeButton"></close-save-button>

        <iron-icon id="lightIcon" class="bottom itemIcons" 
                   icon="custom-icons:[[light.icon]]" 
                   hidden$="[[!light.icon]]">
        </iron-icon>

        <span id="bottomTitle" class="bottom dialogTitle noSelect">[[light.label]]</span>

        <div id="total" class="bottom total">[[light.qty]]</div>

      </paper-toolbar>

      <div id="content">

        <paper-input label="Fixture Quantity"
                     class="inputs"
                     type="tel" 
                     min="0"
                     maxLength="5" 
                     value="{{light.qty}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
        </paper-input>

        <paper-dropdown-menu label="Number of Lamps">
          <paper-listbox class="dropdown-content" attr-for-selected="id" selected="{{light.lamps}}">
            <paper-item id="1">1</paper-item>
            <paper-item id="2">2</paper-item>
            <paper-item id="3">3</paper-item>
            <paper-item id="4">4</paper-item>
            <paper-item id="6">6</paper-item>
            <paper-item id="8">8</paper-item>
            <paper-item id="10">10</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>


        <paper-input label="Wattage"
                     type="tel" 
                     min="0"
                     maxLength="4" 
                     value="{{light.watts}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
          <div suffix>W</div>
        </paper-input>

        <paper-dropdown-menu label="Color Temperature (Kelvin)">
          <paper-listbox class="dropdown-content" attr-for-selected="id" selected="{{light.kelvin}}">
            <paper-item id="2700">2700K</paper-item>
            <paper-item id="3000">3000K</paper-item>
            <paper-item id="3500">3500K</paper-item>
            <paper-item id="4000">4000K</paper-item>
            <paper-item id="4500">4500K</paper-item>
            <paper-item id="5000">5000K</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu label="Input Voltage">
          <paper-listbox class="dropdown-content" attr-for-selected="id" selected="{{light.volts}}">
            <paper-item id="120">120V</paper-item>
            <paper-item id="208">208V</paper-item>
            <paper-item id="240">240V</paper-item>
            <paper-item id="277">277V</paper-item>
            <paper-item id="480">480V</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu label="Fixture Color">
          <paper-listbox class="dropdown-content" attr-for-selected="id" selected="{{light.color}}">
            <paper-item id="white">White</paper-item>
            <paper-item id="grey">Grey</paper-item>
            <paper-item id="black">Black</paper-item>
            <paper-item id="bronze">Bronze</paper-item>
            <paper-item id="custom">Custom</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>


        <paper-input label="Base Type"
                     autocapitalize
                     required 
                     maxLength="30" 
                     char-counter
                     allowed-pattern="[0-9a-zA-Z\s]"
                     prevent-invalid-input 
                     value="{{light.base}}">
        </paper-input>


        <!-- <paper-input label="Mount Type"
                     autocapitalize
                     autocomplete 
                     autocorrect 
                     required 
                     maxLength="30" 
                     char-counter
                     allowed-pattern="[0-9a-zA-Z\s]"
                     prevent-invalid-input 
                     value="{{light.mount}}">
        </paper-input> -->

        <paper-dropdown-menu label="Mount Type">
          <paper-listbox class="dropdown-content" attr-for-selected="id" selected="{{light.mount}}">
            <paper-item id="pendant">Pendant</paper-item>
            <paper-item id="chain">Chain</paper-item>
            <paper-item id="cable">Cable</paper-item>
            <paper-item id="slip">Slip Fitter</paper-item>
            <paper-item id="square">Square Arm</paper-item>
            <paper-item id="trunnion">Trunnion/Swivel</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>


        <paper-input label="Mounting Height"
                     type="tel" 
                     min="0"
                     maxLength="3" 
                     value="{{light.height}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
          <div suffix>ft</div>
        </paper-input>


        <paper-input label="Hours of Operation"
                     type="tel" 
                     min="0"
                     maxLength="2" 
                     value="{{light.hours}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
          <div suffix>hours per day</div>
        </paper-input>

        <paper-input label="Operating Days"
                     type="tel" 
                     min="0"
                     maxLength="1" 
                     value="{{light.days}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
          <div suffix>days per week</div>
        </paper-input>


        <paper-input label="Contactor Quantity (exterior only)"
                     type="tel" 
                     min="0"
                     maxLength="2" 
                     value="{{light.contactors}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
        </paper-input>


        <paper-input label="Emergency Backup Quantity"
                     type="tel" 
                     min="0"
                     maxLength="4" 
                     value="{{light.emergency}}"
                     allowed-pattern="[0-9]"
                     prevent-invalid-input>
        </paper-input>


        <div class="controlsLabel">Controls/Sensors</div>
        <paper-checkbox checked="{{light.controls.dimmer}}">Dimmer</paper-checkbox>
        <paper-checkbox checked="{{light.controls.timer}}">Timer</paper-checkbox>
        <paper-checkbox checked="{{light.controls.motion}}">Occupancy Sensor</paper-checkbox>
        <paper-checkbox id="lastInput" checked="{{light.controls.light}}">Daylight Sensor</paper-checkbox>


      </div>    

    </paper-scroll-header-panel>

    

  </template>

  <script>
    (function() {
      Polymer({
        is: 'bom-edit-fullscreen',

        behaviors: [
        	window.Redaap.Behaviors.Utilities,
          window.Redaap.Behaviors.OnTapBehavior,
          window.Redaap.Behaviors.OpenCloseFullscreenBehavior, 
          window.Redaap.Behaviors.ExpandCollapseClassesBehavior 
        ],

        properties: {

        	animationConfig: {
            value() {
              return {
                'entry': [{
                  name: 'slide-from-top-animation',
                  node: this,
                  timing: {duration: 300, easing: 'ease-out'}
                }, {
                  name: 'cascaded-animation',
                  animation: 'slide-from-top-animation',
                  nodes:  [
                    this.$.title,
                    this.$.lightIcon,
                    this.$.bottomTitle,
                    this.$.capture,
                    this.$.notes,
                    this.$.closeButton,
                  ],
                  timing: {duration: 300, easing: 'ease-out'}
                }, {
                  name: 'cascaded-animation',
                  animation: 'fade-in-animation',
                  nodes:  [
                    this.$.title,
                    this.$.lightIcon,
                    this.$.bottomTitle,
                    this.$.capture,
                    this.$.notes,
                    this.$.closeButton,
                  ],
                  timing: {duration: 200, delay: 100, easing: 'ease-in'}
                }, {
                  name: 'slide-from-bottom-animation',
                  node: this.$.content,
                  timing: {duration: 700, easing: 'ease-out'}
                }, {
                  name: 'fade-in-animation',
                  node: this.$.content,
                  timing: {duration: 100, delay: 600, easing: 'ease-out'}
                }, {
                  name: 'scale-up-animation',
                  node: this.$.total,
                  timing: {duration: 400, delay: 500, easing: 'ease-out'}
                }, {
                  name: 'fade-in-animation',
                  node: this.$.total,
                  timing: {duration: 150, delay: 750, easing: 'ease-out'}
                }],
                'bomEditBack': [{
                  name: 'slide-left-animation',
                  node: this,
                  timing: {duration: 300, easing: 'ease-in'}
                }, {
                  name: 'fade-out-animation',
                  node: this,
                  timing: {duration: 200, delay: 100, easing: 'ease-in'}
                }]
              };
            }
          },

          area: String,

          light: Object,

          photo: {
          	type: Object,
          	computed: '_computePhoto(light.photos)'
          },

          orientation: {
          	type: Number,
          	computed: '_computeOrientation(photo.orientation)',
          	observer: '_orientationChanged'
          },
          // trigger the photos to load after the entry animation completes
          deferPhoto: {
            type: Boolean,
            notify: true
          }
        },


        listeners: {
          'neon-animation-finish':      '_bomFullscreenAnimationFinished',
          // fired by photo-capture once a temporary url has been passed back from worker
          'photo-capture-placeholder':  '_placeHolderSrcFromPhotoCapture',
          // fired by photo-capture once a url has been passed back from db
          'photo-capture-external-src': '_externalSrcFromPhotoCapture',
          // fired by close-save-button
          'close-save-button-tapped':   '_bomCloseButtonTapped'
        },

        // animation config setup since headerContainer is dynamically
        // created by paper-scroll-header-panel
        ready() {
          // for animation config setup
          const header   = Polymer.dom(this.$.panel).node.$.headerContainer;
          // must create two divs inside the header backgound div in order
          // to correct the image orientation
          // one for placeholder ObjectURL and the other is for the saved url from db
          const headerBg = Polymer.dom(this.$.panel).node.$.headerBg;
          this.backgroundImagePlaceholder = document.createElement('div');
          this.backgroundImage            = document.createElement('div');
          // initial styles for both divs with no orientation correction
          this._setupBackgroundImageDiv(this.backgroundImagePlaceholder);
          this._setupBackgroundImageDiv(this.backgroundImage);
          // add them to header background
          Polymer.dom(headerBg).appendChild(this.backgroundImagePlaceholder);
          Polymer.dom(headerBg).appendChild(this.backgroundImage);
        },


        init(area, light) {
        	console.log('bom fullscreen init: ', light);

        	const callback = () => {
        		this.deferPhoto = true;
        	};

        	this.area 			= area;
        	this.light 			= light;
        	this.deferPhoto = false;
        	this.open(callback);
        },

        // initial styles for both background divs that are appended to header panel background
        _setupBackgroundImageDiv(element) {
          element.style.height             = '100%';
          element.style.position           = 'absolute';
          element.style.top                = '0px';
          element.style.bottom             = '0px';
          element.style.left               = '0px';
          element.style.right              = '0px';
          element.style.backgroundRepeat   = 'no-repeat';
          element.style.backgroundSize     = 'cover';
          element.style.backgroundPosition = 'center center';
          element.style.transform          = 'rotate(0deg)';
          element.style.opacity            = '0';
        },


        _computeOrientation: orientation => orientation,


        _correctOrientation(elements, num = 1) {
          const config = {
            1: {height: '100%',  pos: 'center center', rotate: '0'},
            3: {height: '100%',  pos: 'center center', rotate: '180'},
            6: {height: '100vw', pos: 'center right',  rotate: '90'},
            8: {height: '100vw', pos: 'center left',   rotate: '-90'}
          };
          const {height, pos, rotate} = config[num];

          elements.forEach(element => {
            element.style.height             = height;
            element.style.backgroundPosition = pos;
            element.style.transform          = `rotate(${rotate}deg)`;
          });
        },

        // photo-capture image orientation correction for both background divs
        _orientationChanged(orientation) {
          const elements = [this.backgroundImage, this.backgroundImagePlaceholder];

          switch (orientation) {
            case 3:
              this._correctOrientation(elements, 3);
              break;
            case 6:
              this._correctOrientation(elements, 6);
              break;
            case 8:
              this._correctOrientation(elements, 8);
              break;
            default:
              this._correctOrientation(elements);
              break;
          }
        },


        _setPlaceholderBackground(url) {
          this.backgroundImagePlaceholder.style.backgroundImage = `url(${url})`;
          this.backgroundImagePlaceholder.style.transition      = 'opacity 0.3s ease-out';
          this.backgroundImagePlaceholder.style.opacity         = '1';
        },


        _resetPlaceholderBackground() {
          this.backgroundImagePlaceholder.style.backgroundImage = 'none';
          this.backgroundImagePlaceholder.style.transition      = '';
          this.backgroundImagePlaceholder.style.opacity         = '0';
        },


        _setExternalSrcBackground(url) {
          this.backgroundImage.style.backgroundImage = `url(${url})`;
          this.backgroundImage.style.opacity         = '1';
        },


        _resetExternalSrcBackground() {
          this.backgroundImage.style.backgroundImage = 'none';
          this.backgroundImage.style.opacity         = '0';
        },
        // photo-capture placeholder event
        // controls header background img placeholder
        // placeholder is set first before the img file has had time to be saved to db
        // it is removed 500ms after main background div src has been set to avoid flicker
        _placeHolderSrcFromPhotoCapture(event) {
          const url = event.detail.placeholder;
          if (url && url !== '#') {
            this._resetExternalSrcBackground();
            this._setPlaceholderBackground(url);
          } else {
            this._resetPlaceholderBackground();
          }
        },
        // photo-capture external-src event
        // controls header background img
        // is set once the img file has been saved to db and then reloaded into browser
        _externalSrcFromPhotoCapture(event) {
          const url = event.detail.externalSrc;
          if (url) {
            this._setExternalSrcBackground(url);
          } else {
            this._resetExternalSrcBackground();
          }
        },


        _computePhoto(photos) {
          // TODO: 
          //      sort by timestamp in key
          const {key, orientation, placeholder, savedUrl} = photos[photos.length - 1];
          const keys = photos.reduce((prev, curr) => prev[curr.key] = curr, {});

          return {key, keys, orientation, placeholder, savedUrl};
        },


        _bomFullscreenAnimationFinished(_, animationType) {
          if (animationType === 'bomEditBack') {
            this.close();
          }
        },


        _bomBackButtonTapped() {
        	const back = () => {
        		this.cancelAnimation();
        		this.playAnimation('bomEditBack', 'bomEditBack');
        	};

        	this.onTap = back;
        },


        _bomCloseButtonTapped(event) {
        	// shared back button custom element 
        	// so eat the event to stop bubbling
        	event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          this.onTap = this.fire.bind(this, 'bom-edit-fullscreen-close-button-tapped');
        }

      });
    })();
  </script>

</dom-module>
